<script>
document.addEventListener('DOMContentLoaded', () => {
  const FREE_GIFT_ID = {{ settings.free_gift.selected_or_first_available_variant.id }};
  const FREE_GIFT_THRESHOLD = {{ settings.free_gift_threshold }} * 100;

  const addGift = async (variantId, quantity = 1) => {
    const res = await fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: variantId, quantity, properties: { FREE_GIFT: true } })
    });
    if (!res.ok) throw new Error(`Error adding gift: ${res.status}`);
    return res.json();
  };

  const removeGift = async (lineKey) => {
    const res = await fetch('/cart/change.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: lineKey, quantity: 0 })
    });
    if (!res.ok) throw new Error(`Error removing gift: ${res.status}`);
    return res.json();
  };

  const getCart = async () => {
    const res = await fetch('/cart.js');
    if (!res.ok) throw new Error(`Error fetching cart: ${res.status}`);
    return res.json();
  };

  const manageFreeGift = async () => {
    try {
      const cart = await getCart();
      const eligible = cart.total_price >= FREE_GIFT_THRESHOLD;
      const giftItem = cart.items.find(i => i.variant_id == FREE_GIFT_ID);

      if (eligible && !giftItem) {
        console.log('Adding free gift 🎁');
        await addGift(FREE_GIFT_ID, 1);
      } else if (!eligible && giftItem) {
        console.log('Removing free gift ❌');
        await removeGift(giftItem.key);
      } else {
        console.log('No action needed.');
      }
    } catch (err) {
      console.error('Free gift error:', err);
    }
  };

  // ✅ Run on page load
  manageFreeGift();

  // ✅ Listen for cart updates (works with drawer and AJAX updates)
  document.addEventListener('cart:updated', () => {
    manageFreeGift();
  });

  // ✅ Optional: override Dawn pub/sub if using cart-items component
  if (window.PUB_SUB_EVENTS && window.subscribe) {
    subscribe(PUB_SUB_EVENTS.cartUpdate, (event) => {
      if (!event.detail || event.detail.source !== 'free-gift') {
        manageFreeGift();
      }
    });
  }
});
</script>
